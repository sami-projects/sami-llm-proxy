# Как работает сеть Docker контейнера

## Как это работает

### Схема работы:

```
Sami (Windows)                    Ubuntu Server (81.85.76.160)
    |                                      |
    |  Запрос на 81.85.76.160:8080        |
    |------------------------------------->|
    |                                      | Docker Host
    |                                      |   |
    |                                      |   | -p 8080:8080
    |                                      |   | (проброс порта)
    |                                      |   v
    |                                      | Docker Container
    |                                      |   |
    |                                      |   | server.listen(8080, '0.0.0.0')
    |                                      |   | (слушает внутри контейнера)
    |                                      |   |
    |<-------------------------------------|   |
    |  Ответ через прокси                  |   |
```

### Пошагово:

1. **Внутри контейнера:**
   - Сервер слушает на `0.0.0.0:8080` (все интерфейсы внутри контейнера)
   - Это означает: "принимай соединения на любом интерфейсе внутри контейнера"

2. **Docker проброс порта (`-p 8080:8080`):**
   - `-p 8080:8080` означает: "пробрось порт 8080 хоста на порт 8080 контейнера"
   - Запросы на `81.85.76.160:8080` попадают на хост
   - Docker автоматически перенаправляет их в контейнер на порт 8080

3. **Из Sami:**
   - Вы указываете: `Host: 81.85.76.160`, `Port: 8080`
   - Запрос идет на `81.85.76.160:8080`
   - Попадает на хост → Docker перенаправляет в контейнер → прокси обрабатывает

---

## Важно: Firewall на сервере

**На Ubuntu сервере нужно открыть порт 8080:**

```bash
# Проверить статус firewall
sudo ufw status

# Открыть порт 8080
sudo ufw allow 8080/tcp

# Или для конкретного IP (безопаснее):
sudo ufw allow from YOUR_IP to any port 8080
```

**Без открытого порта в firewall:**
- Запросы извне будут блокироваться
- Контейнер будет работать, но недоступен снаружи

---

## Проверка работы

### 1. На сервере (проверить, что контейнер слушает):

```bash
# Проверить, что контейнер запущен
docker ps | grep sami-llm-proxy

# Проверить, что порт проброшен
docker port sami-llm-proxy
# Должно показать: 0.0.0.0:8080->8080/tcp

# Проверить изнутри контейнера
docker exec sami-llm-proxy netstat -tuln | grep 8080
# Должно показать: tcp 0 0 0.0.0.0:8080
```

### 2. С Windows (проверить доступность):

```bash
# Проверить доступность порта
telnet 81.85.76.160 8080
# Или:
Test-NetConnection -ComputerName 81.85.76.160 -Port 8080

# Проверить работу прокси
curl -x http://81.85.76.160:8080 https://www.google.com
```

### 3. Просмотр логов на сервере:

```bash
# Подключиться к серверу
ssh user@81.85.76.160

# Следить за логами в реальном времени
docker logs -f sami-llm-proxy

# Посмотреть последние 100 строк
docker logs --tail 100 sami-llm-proxy

# Логи с временными метками
docker logs -f --timestamps sami-llm-proxy

# Фильтровать по ошибкам
docker logs -f sami-llm-proxy | grep -i error
```

---

## Почему `0.0.0.0` правильно для Docker?

**Внутри контейнера:**
- `0.0.0.0` = "слушать на всех интерфейсах внутри контейнера"
- Это нужно, чтобы Docker мог пробросить порт

**Если бы было `127.0.0.1`:**
- Сервер слушал бы только на localhost внутри контейнера
- Docker не смог бы пробросить порт наружу
- Контейнер был бы недоступен снаружи

---

## Пример полной настройки

**На сервере:**

```bash
# 1. Запустить контейнер
docker run -d \
  --name sami-llm-proxy \
  -p 8080:8080 \
  --restart unless-stopped \
  sami-llm-proxy

# 2. Открыть порт в firewall
sudo ufw allow 8080/tcp

# 3. Проверить
curl -x http://localhost:8080 https://www.google.com
```

**В настройках Sami:**
- Host: `81.85.76.160`
- Port: `8080`
- Type: `http`
- Username/Password: (если настроено)

---

## Troubleshooting

### Проблема: "Connection refused" из Sami

**Проверьте:**
1. Контейнер запущен: `docker ps | grep sami-llm-proxy`
2. Порт открыт в firewall: `sudo ufw status`
3. Порт проброшен: `docker port sami-llm-proxy`
4. Доступность с сервера: `curl -x http://localhost:8080 https://www.google.com`
5. Доступность извне: `telnet 81.85.76.160 8080`

### Проблема: "Timeout" из Sami

**Возможные причины:**
- Firewall блокирует порт
- Провайдер блокирует порт
- Неправильный IP адрес

**Решение:**
- Проверить firewall: `sudo ufw status`
- Проверить логи контейнера: `docker logs sami-llm-proxy`
- Попробовать другой порт (например, 8081)

