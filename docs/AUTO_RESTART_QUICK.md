# Быстрая настройка автоперезапуска

## Минимальная настройка (обязательно)

Для базового автоперезапуска нужно сделать **2 вещи**:

### 1. Docker restart policy (уже в docker-compose.yml) ✅

В `docker-compose.yml` уже есть:
```yaml
restart: unless-stopped
```

Это означает, что контейнер будет перезапускаться при сбоях, **НО только если Docker запущен**.

### 2. Автозапуск Docker при загрузке системы (нужно настроить)

**Проблема:** Если сервер перезагрузится, Docker может не запуститься автоматически.

**Решение:** Включите автозапуск Docker:

```bash
# Проверьте текущий статус
sudo systemctl is-enabled docker

# Если выведет "disabled", включите автозапуск:
sudo systemctl enable docker

# Проверьте еще раз
sudo systemctl is-enabled docker
# Должно вывести "enabled"
```

**Это все!** Теперь:
- ✅ Docker запустится при загрузке системы
- ✅ Контейнер перезапустится при сбоях (благодаря `restart: unless-stopped`)
- ⚠️ Контейнер **НЕ перезапустится**, если вы остановили его вручную (`docker stop`)

---

## Проверка работы

### Тест 1: Перезагрузка сервера

```bash
# Перезагрузите сервер
sudo reboot

# После перезагрузки проверьте:
docker ps | grep sami-llm-proxy
# Контейнер должен быть запущен
```

### Тест 2: Имитация сбоя

**Важно:** `docker stop` НЕ перезапустит контейнер (он остановлен вручную).  
Для имитации реального сбоя нужно убить процесс контейнера:

```bash
# Убить процесс контейнера (имитация сбоя)
docker kill sami-llm-proxy

# Подождите 10 секунд и проверьте
docker ps | grep sami-llm-proxy
# Контейнер должен автоматически перезапуститься
```

**Разница:**
- `docker stop` → контейнер остановлен вручную → **НЕ перезапустится**
- `docker kill` → контейнер убит (имитация сбоя) → **перезапустится автоматически**

---

## Управление контейнером

### Как остановить контейнер навсегда

**Важно:** `restart: unless-stopped` означает, что контейнер **НЕ перезапустится**, если вы остановили его **вручную**.

#### Вариант 1: Остановить через docker-compose (рекомендуется)

```bash
# Остановить и удалить контейнер
docker-compose down

# Контейнер остановлен и НЕ перезапустится автоматически
```

#### Вариант 2: Остановить через docker

```bash
# Остановить контейнер
docker stop sami-llm-proxy

# Контейнер остановлен и НЕ перезапустится автоматически
# (благодаря политике "unless-stopped")
```

#### Вариант 3: Удалить контейнер полностью

```bash
# Остановить и удалить контейнер
docker-compose down

# Или через docker:
docker stop sami-llm-proxy
docker rm sami-llm-proxy
```

### Как запустить снова

```bash
# Запустить через docker-compose
docker-compose up -d

# Или через docker (если контейнер удален, нужно создать заново)
docker run -d \
  --name sami-llm-proxy \
  --restart=unless-stopped \
  -p 8080:8080 \
  sami-llm-proxy
```

### Разница между командами

| Команда | Что делает | Перезапустится? |
|---------|------------|-----------------|
| `docker stop sami-llm-proxy` | Останавливает контейнер | ❌ Нет (остановлен вручную) |
| `docker-compose down` | Останавливает и удаляет контейнер | ❌ Нет |
| Сбой/перезагрузка сервера | Контейнер упал сам | ✅ Да (автоматически) |
| `docker restart sami-llm-proxy` | Перезапускает контейнер | ✅ Да (вручную) |

### Временная остановка vs Полная остановка

**Временная остановка (для обслуживания):**
```bash
docker stop sami-llm-proxy
# Контейнер остановлен, но не удален
# Можно запустить снова: docker start sami-llm-proxy
```

**Полная остановка (удаление):**
```bash
docker-compose down
# Контейнер остановлен и удален
# Нужно создать заново: docker-compose up -d
```

### Отключить автоперезапуск навсегда

Если хотите полностью отключить автоперезапуск:

1. **Временно:** Остановите контейнер (`docker stop` или `docker-compose down`)
2. **Навсегда:** Измените `docker-compose.yml`:
   ```yaml
   # Замените:
   restart: unless-stopped
   # На:
   restart: "no"
   ```
   Затем пересоздайте контейнер:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

---

## Дополнительная настройка (опционально, для большей надежности)

Если хотите еще больше контроля, можете настроить systemd service для управления контейнером. Это даст:

- ✅ Управление через `systemctl start/stop/restart sami-proxy`
- ✅ Логирование в systemd journal
- ✅ Более надежный автозапуск

**Инструкции:** См. [AUTO_RESTART.md](./AUTO_RESTART.md) раздел "Systemd Service"

---

## Итого: что нужно сделать

### Минимально (обязательно):
1. ✅ `restart: unless-stopped` в docker-compose.yml (уже есть)
2. ⚠️ `sudo systemctl enable docker` (выполните на сервере)

### Опционально (для production):
3. Systemd service для управления контейнером

---

## Частые вопросы

**Q: Достаточно ли только docker-compose.yml?**  
A: Нет. Нужно еще включить автозапуск Docker (`systemctl enable docker`).

**Q: Что произойдет, если я не настрою автозапуск Docker?**  
A: При перезагрузке сервера Docker не запустится автоматически, и контейнер не запустится.

**Q: Нужен ли systemd service?**  
A: Не обязательно, но рекомендуется для production. Минимальная настройка (автозапуск Docker) обычно достаточна.

**Q: Как проверить, что все работает?**  
A: Перезагрузите сервер и проверьте `docker ps | grep sami-llm-proxy` - контейнер должен быть запущен.

**Q: Почему `docker stop` не перезапускает контейнер?**  
A: `restart: unless-stopped` означает "перезапускать, если не остановлен вручную". `docker stop` - это ручная остановка, поэтому контейнер не перезапустится. Для имитации сбоя используйте `docker kill`.

**Q: Как остановить контейнер навсегда?**  
A: Используйте `docker stop` или `docker-compose down`. Контейнер не перезапустится, т.к. он остановлен вручную.

